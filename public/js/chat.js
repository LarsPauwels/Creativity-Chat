"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var messageBtn=document.getElementById("sendMessage"),messageInput=document.getElementById("message"),chat=document.getElementById("chat"),users=document.getElementById("users"),messageId=document.getElementById("messageId"),updateSend=document.getElementById("updateSend"),updateDecline=document.getElementById("updateDecline"),idInput=document.getElementById("messageId"),Message=function(){function n(){_classCallCheck(this,n)}return _createClass(n,[{key:"createMessage",value:function(){var t,e={text:messageInput.value,user:Cookie.getCookie("username")};fetch("./api/v1/messages",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){t=e.id,n.setPrimus(t,"createMessage")}).catch(function(e){console.log(e)})}},{key:"getMessages",value:function(){var n=this;fetch("./api/v1/messages",{method:"get",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){var s=0,a=new Array;e.message.forEach(function(e){if(a.push(n.getTime(e.timestamp)),2<=a.length){var t=s-1;108e4<=a[s]-a[t]&&(chat.innerHTML+='<div class="message__date"><span class="message__date--text">'.concat(e.timestamp,"</span></div>"))}Cookie.getCookie("username")==e.user?chat.innerHTML+='<div class="message--right"><span class="message__delete fa fa-trash" onclick="removeMessage()"></span><div class="message" onclick="changeMessage(this)" data-id="'.concat(e._id,'">').concat(e.text,"</div><div>"):chat.innerHTML+='<div class="message message--red" data-id="'.concat(e._id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.text,"</div>"),s++}),chat.scrollTop=chat.scrollHeight}).catch(function(e){console.log(e)})}},{key:"updateMessage",value:function(){var t=idInput.value,e=messageInput.value,s="./api/v1/messages/".concat(t),a={text:e};fetch(s,{method:"put",headers:{"Content-type":"application/json"},body:JSON.stringify(a)}).then(function(e){return e.json()}).then(function(e){n.setPrimus(t,"updateMessage"),addMessage()}).catch(function(e){console.log(e)})}},{key:"deleteMessage",value:function(){var t=idInput.value,e="./api/v1/messages/".concat(t);fetch(e,{method:"delete",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){n.setPrimus(t,"deleteMessage"),addMessage()}).catch(function(e){console.log(e)})}},{key:"getTime",value:function(e){var t=e.split(" "),s=t[1].split(":"),a=t[0].split("/");return new Date(a[2],parseInt(a[1],10)-1,a[0],s[0],s[1]).getTime()}}],[{key:"setPrimus",value:function(e,t){var s=messageInput.value,a=(new Cookie,Cookie.getCookie("username"));this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}}),this.primus.write({user:a,message:s,id:e,type:t}),messageInput.value=""}}]),n}(),IMDBot=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"botRequest",value:function(){var e=message.value.replace("@IMDBot",""),t="https://api.wit.ai/message?v=20190518&q=".concat(e);fetch(t,{method:"get",headers:{Authorization:"Bearer LDAHTGYL7ZM3Y636JBPSA5XTXYVYHEVA"}}).then(function(e){return e.json()}).then(function(e){a.checkIntent(e)}).catch(function(e){console.log(e)})}}],[{key:"setPrimus",value:function(e,t,s,a){this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}}),this.primus.write({user:s,message:a,id:e,type:t})}},{key:"checkIntent",value:function(e){switch(e.entities.intent[0].value){case"play_clip":a.youtubeRequest(e)}}},{key:"youtubeRequest",value:function(e){var t="https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&order=rating&q=".concat(e.entities.query[0].value,"&type=video&videoEmbeddable=true&key=AIzaSyCq26SiNiH7Qcec_xKTF5NB06VBdvteFE0");fetch(t,{method:"get"}).then(function(e){return e.json()}).then(function(e){var t='<iframe class="message__iframe" width="560" height="315" src="https://www.youtube.com/embed/'.concat(e.items[0].id.videoId,'" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>');a.createMessage(t)}).catch(function(e){console.log(e)})}},{key:"createMessage",value:function(t){var s,e={text:t,user:"IMDBot"};fetch("./api/v1/messages",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){s=e.id,a.setPrimus(s,"createMessageBot","IMDBot",t)}).catch(function(e){console.log(e)})}}]),a}(),User=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getUsers",value:function(){fetch("./api/v1/user",{method:"get",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){e.message.forEach(function(e){users.innerHTML+='<li class="user"><div class="user--center"><div class="user__picture"></div><span class="user__name">'.concat(e.username,'</span><span class="user_status">Online</span></div></li>')})}).catch(function(e){console.log(e)})}}]),e}(),Cookie=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"setCookie",value:function(e,t,s){var a="";if(s){var n=new Date;n.setTime(n.getTime()+24*s*60*60*1e3),a="; expires="+n.toUTCString()}document.cookie=e+"="+(t||"")+a+"; path=/"}},{key:"getCookie",value:function(e){for(var t=e+"=",s=document.cookie.split(";"),a=0;a<s.length;a++){for(var n=s[a];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return null}}]),e}();null==Cookie.getCookie("username")&&(location.href="index.html");var m=new Message;m.getMessages();var u=new User;function messagePlaced(){var e=message.value;""!=e&&(-1!=e.search("@IMDBot")?((new Message).createMessage(),(new IMDBot).botRequest()):(new Message).createMessage())}u.getUsers(),messageBtn.addEventListener("click",function(e){messagePlaced(),e.preventDefault()}),messageInput.addEventListener("keypress",function(e){13==e.keyCode&&(messagePlaced(),e.preventDefault())});var primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}});function changeMessage(e){messageBtn.style.display="none",updateDecline.style.display="inline-block",updateSend.style.display="inline-block";var t=e.innerHTML;messageInput.value=t;var s=e.getAttribute("data-id");messageId.value=s,e.previousSibling.style.display="inline-block"}function removeMessage(){(new Message).deleteMessage()}function addMessage(e){var t=document.querySelector('[data-id="'.concat(messageId.value,'"]'));messageBtn.style.display="inline-block",updateDecline.style.display="none",updateSend.style.display="none",t.previousSibling.style.display="none",messageInput.value="",messageId.value=""}primus.on("data",function(e){var t;switch(e.type){case"addUser":users.innerHTML+='<li class="user"><div class="user--center"><div class="user__picture"></div><span class="user__name">'.concat(e.username,'</span><span class="user_status">Online</span></div></li>');break;case"createMessage":Cookie.getCookie("username")==e.user?chat.innerHTML+='<div class="message--right"><span class="message__delete fa fa-trash" onclick="removeMessage()"></span><div class="message" onclick="changeMessage(this)" data-id="'.concat(e.id,'">').concat(e.message,"</div></div>"):chat.innerHTML+='<div class="message message--red" data-id="'.concat(e.id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.message,"</div>");break;case"updateMessage":t=document.querySelector('[data-id="'.concat(e.id,'"]')),Cookie.getCookie("username")==e.user?t.innerHTML=e.message:t.innerHTML='<span class="message__user">'.concat(e.user,": </span> ").concat(e.message);break;case"deleteMessage":(t=document.querySelector('[data-id="'.concat(e.id,'"]'))).parentElement.removeChild(t);break;case"createMessageBot":document.querySelectorAll("iframe").forEach(function(e){var t=e.getAttribute("src");if(t.includes("?autoplay=1")){var s=t.split("?");e.setAttribute("src",s[0])}});chat.innerHTML+='<div class="message message--red" data-id="'.concat(e.id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.message,"</div>");var s=document.querySelector('[data-id="'.concat(e.id,'"]')).lastChild,a=s.getAttribute("src")+"?autoplay=1";s.setAttribute("src",a)}}),updateDecline.addEventListener("click",function(e){addMessage(),e.preventDefault()}),updateSend.addEventListener("click",function(e){(new Message).updateMessage(),e.preventDefault()});