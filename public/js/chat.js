"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var messageBtn=document.getElementById("sendMessage"),messageInput=document.getElementById("message"),chat=document.getElementById("chat"),users=document.getElementById("users"),messageId=document.getElementById("messageId"),updateSend=document.getElementById("updateSend"),updateDecline=document.getElementById("updateDecline"),idInput=document.getElementById("messageId"),logout=document.getElementById("logout"),Message=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"createMessage",value:function(){var t,e={text:messageInput.value,user:Cookie.getCookie("username")};fetch("./api/v1/messages",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){t=e.id,a.setPrimus(t,"createMessage")}).catch(function(e){console.log(e)})}},{key:"getMessages",value:function(){var a=this;fetch("./api/v1/messages",{method:"get",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){var s=0,n=new Array;e.message.forEach(function(e){if(n.push(a.getTime(e.timestamp)),2<=n.length){var t=s-1;108e4<=n[s]-n[t]&&(chat.innerHTML+='<div class="message__date"><span class="message__date--text">'.concat(e.timestamp,"</span></div>"))}"beamer"==e.device&&"admin"==Cookie.getCookie("username")||"computer"==e.device&&Cookie.getCookie("username")==e.requester?chat.innerHTML+='<div class="message message--red" data-id="'.concat(e._id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.text,"</div>"):null==e.device&&(Cookie.getCookie("username")==e.user?chat.innerHTML+='<div class="message--right"><span class="message__delete fa fa-trash" onclick="removeMessage()"></span><div class="message" onclick="changeMessage(this)" data-id="'.concat(e._id,'">').concat(e.text,"</div><div>"):chat.innerHTML+='<div class="message message--red" data-id="'.concat(e._id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.text,"</div>")),s++}),chat.scrollTop=chat.scrollHeight}).catch(function(e){console.log(e)})}},{key:"updateMessage",value:function(){var t=idInput.value,e=messageInput.value,s="./api/v1/messages/".concat(t),n={text:e};fetch(s,{method:"put",headers:{"Content-type":"application/json"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){a.setPrimus(t,"updateMessage"),addMessage()}).catch(function(e){console.log(e)})}},{key:"deleteMessage",value:function(){var t=idInput.value,e="./api/v1/messages/".concat(t);fetch(e,{method:"delete",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){a.setPrimus(t,"deleteMessage"),addMessage()}).catch(function(e){console.log(e)})}},{key:"getTime",value:function(e){var t=e.split(" "),s=t[1].split(":"),n=t[0].split("/");return new Date(n[2],parseInt(n[1],10)-1,n[0],s[0],s[1]).getTime()}}],[{key:"setPrimus",value:function(e,t){var s=messageInput.value,n=(new Cookie,Cookie.getCookie("username"));this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}}),this.primus.write({user:n,message:s,id:e,type:t}),messageInput.value=""}}]),a}(),IMDBot=function(){function i(){_classCallCheck(this,i)}return _createClass(i,[{key:"botRequest",value:function(){var t=Cookie.getCookie("username"),e=message.value.replace("@IMDBot",""),s="https://api.wit.ai/message?v=20190518&q=".concat(e);fetch(s,{method:"get",headers:{Authorization:"Bearer LDAHTGYL7ZM3Y636JBPSA5XTXYVYHEVA"}}).then(function(e){return e.json()}).then(function(e){i.checkIntent(e,t)}).catch(function(e){console.log(e)})}}],[{key:"setPrimus",value:function(e,t,s,n,a,i){this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}}),this.primus.write({user:s,message:n,id:e,type:t,device:a,requester:i})}},{key:"checkIntent",value:function(e,t){switch(e.entities.intent[0].value){case"play_clip":var s=e.entities.device[0].value;i.youtubeRequest(e,s,t)}}},{key:"youtubeRequest",value:function(e,n,a){var t="https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&order=rating&q=".concat(e.entities.query[0].value,"&type=video&videoEmbeddable=true&key=AIzaSyCq26SiNiH7Qcec_xKTF5NB06VBdvteFE0");fetch(t,{method:"get"}).then(function(e){return e.json()}).then(function(e){var t="Enjoy your video ".concat(a,"!"),s='<iframe class="message__iframe" width="560" height="315" src="https://www.youtube.com/embed/'.concat(e.items[0].id.videoId,'" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>');i.createMessage(t+s,n,a)}).catch(function(e){console.log(e)})}},{key:"createMessage",value:function(t,s,n){var a,e={text:t,user:"IMDBot",device:s,requester:n};fetch("./api/v1/messages",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){a=e.id,i.setPrimus(a,"createMessageBot","IMDBot",t,s,n)}).catch(function(e){console.log(e)})}}]),i}(),User=function(){function s(){_classCallCheck(this,s)}return _createClass(s,[{key:"getUsers",value:function(){fetch("./api/v1/user",{method:"get",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){e.message.forEach(function(e){1==e.active?users.innerHTML+='<li class="user" data-user="'.concat(e.username,'"><div class="user--center"><div class="user__picture"></div><span class="user__name">').concat(e.username,'</span><span class="user__status">Online</span></div></li>'):users.innerHTML+='<li class="user" data-user="'.concat(e.username,'"><div class="user--center"><div class="user__picture"></div><span class="user__name">').concat(e.username,'</span><span class="user__status user__status--red">Online</span></div></li>')})}).catch(function(e){console.log(e)})}},{key:"logout",value:function(){var t=Cookie.getCookie("username"),e="./api/v1/user?user=".concat(t);fetch(e,{method:"put",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){"success"==e.status&&null!=t&&s.setPrimus(t,"Offline","userStatus")&&(Cookie.deleteCookie("username"),location.href="index.html")}).catch(function(e){console.log(e)})}},{key:"login",value:function(){var t=Cookie.getCookie("username"),e="./api/v1/user?user=".concat(t);fetch(e,{method:"get",headers:{"Content-type":"application/json"}}).then(function(e){return e.json()}).then(function(e){"error"==e.status?(Cookie.deleteCookie("username"),location.href="index.html"):s.setPrimus(t,"Online","userStatus")}).catch(function(e){console.log(e)})}}],[{key:"setPrimus",value:function(e,t,s){return this.primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}}),this.primus.write({user:e,type:s,status:t}),!0}}]),s}(),Cookie=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"setCookie",value:function(e,t,s){var n="";if(s){var a=new Date;a.setTime(a.getTime()+24*s*60*60*1e3),n="; expires="+a.toUTCString()}document.cookie=e+"="+(t||"")+n+"; path=/"}},{key:"getCookie",value:function(e){for(var t=e+"=",s=document.cookie.split(";"),n=0;n<s.length;n++){for(var a=s[n];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(t))return a.substring(t.length,a.length)}return null}},{key:"deleteCookie",value:function(e){document.cookie=e+"=; Max-Age=-99999999;"}}]),e}();null==Cookie.getCookie("username")&&(location.href="index.html");var m=new Message;m.getMessages();var u=new User;function messagePlaced(){var e=message.value;if(""!=e){if(-1!=e.search("@IMDBot"))(new IMDBot).botRequest();(new Message).createMessage()}}u.getUsers(),messageBtn.addEventListener("click",function(e){messagePlaced(),e.preventDefault()}),messageInput.addEventListener("keypress",function(e){13==e.keyCode&&(messagePlaced(),e.preventDefault())}),logout.addEventListener("click",function(e){(new User).logout(),e.preventDefault()}),window.onbeforeunload=function(){(new User).logout()},window.onload=function(){(new User).login()};var primus=Primus.connect("/",{reconnect:{max:1/0,min:500,retries:10}});function changeMessage(e){messageBtn.style.display="none",updateDecline.style.display="inline-block",updateSend.style.display="inline-block";var t=e.innerHTML;messageInput.value=t;var s=e.getAttribute("data-id");messageId.value=s,e.previousSibling.style.display="inline-block"}function removeMessage(){(new Message).deleteMessage()}function addMessage(e){var t=document.querySelector('[data-id="'.concat(messageId.value,'"]'));messageBtn.style.display="inline-block",updateDecline.style.display="none",updateSend.style.display="none",t.previousSibling.style.display="none",messageInput.value="",messageId.value=""}primus.on("data",function(e){var t;switch(e.type){case"addUser":users.innerHTML+='<li class="user" data-user="'.concat(e.username,'"><div class="user--center"><div class="user__picture"></div><span class="user__name">').concat(e.username,'</span><span class="user__status">Online</span></div></li>');break;case"createMessage":Cookie.getCookie("username")==e.user?chat.insertAdjacentHTML("beforeend",'<div class="message--right"><span class="message__delete fa fa-trash" onclick="removeMessage()"></span><div class="message" onclick="changeMessage(this)" data-id="'.concat(e.id,'">').concat(e.message,"</div></div>")):chat.insertAdjacentHTML("beforeend",'<div class="message message--red" data-id="'.concat(e.id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.message,"</div>"));break;case"updateMessage":t=document.querySelector('[data-id="'.concat(e.id,'"]')),Cookie.getCookie("username")==e.user?t.innerHTML=e.message:t.innerHTML='<span class="message__user">'.concat(e.user,": </span> ").concat(e.message);break;case"deleteMessage":(t=document.querySelector('[data-id="'.concat(e.id,'"]'))).parentElement.removeChild(t);break;case"createMessageBot":if("computer"==e.device&&Cookie.getCookie("username")==e.requester||"beamer"==e.device&&"admin"==Cookie.getCookie("username")){var n;document.querySelectorAll("iframe").forEach(function(e){var t=e.getAttribute("src");if(t.includes("?autoplay=1")){var s=t.split("?");e.setAttribute("src",s[0]),n=e}});chat.insertAdjacentHTML("beforeend",'<div class="message message--red" data-id="'.concat(e.id,'"><span class="message__user">').concat(e.user,": </span>").concat(e.message,"</div>"));var s=document.querySelector('[data-id="'.concat(e.id,'"]')).lastChild;if(n!=s){var a=s.getAttribute("src")+"?autoplay=1";s.setAttribute("src",a)}}break;case"userStatus":var i=(t=document.querySelector('[data-user="'.concat(e.user,'"]'))).children[0].children[2];i.innerHTML=e.status,"Online"==e.status?i.classList.remove("user__status--red"):i.classList.add("user__status--red")}}),updateDecline.addEventListener("click",function(e){addMessage(),e.preventDefault()}),updateSend.addEventListener("click",function(e){(new Message).updateMessage(),e.preventDefault()});